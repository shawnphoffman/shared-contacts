name: shared-contacts

services:
  shared-contacts-postgres:
    image: postgres:15-alpine
    container_name: shared-contacts-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sharedcontacts}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ChangeMePlease!!!}
      POSTGRES_DB: sharedcontacts
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # ports:
    #   - '${POSTGRES_PORT:-5432}:5432'
    networks:
      - shared-contacts-network
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-sharedcontacts} -d sharedcontacts' ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
        compress: 'true'

  shared-contacts-app:
    image: ghcr.io/shawnphoffman/shared-contacts:latest
    container_name: shared-contacts-app
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-sharedcontacts}:${POSTGRES_PASSWORD:-ChangeMePlease!!!}@shared-contacts-postgres:5432/sharedcontacts
    volumes:
      - radicale_data:/data
    ports:
      - '${UI_PORT:-3030}:3030'
    networks:
      - shared-contacts-network
    depends_on:
      shared-contacts-postgres:
        condition: service_healthy
    healthcheck:
      test: [ 'CMD-SHELL', 'node -e "require(''http'').get(''http://localhost:3030/api/health'',(r)=>{process.exit(r.statusCode===200?0:1)}).on(''error'',()=>process.exit(1))" || exit 1' ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
        compress: 'true'

networks:
  shared-contacts-network:
    driver: bridge
    name: shared-contacts-network

volumes:
  postgres_data:
    name: shared-contacts-postgres-data
  radicale_data:
    name: shared-contacts-radicale-data
